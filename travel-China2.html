<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>中国地図（実形・省級行政区）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root{
      --bg1:#4f46e5; --bg2:#8b5cf6;
      --panel:#ffffffd9; --ink:#111827;
      --accent:#f59e0b; --stroke:#ffffff;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:linear-gradient(145deg,var(--bg1),var(--bg2));}
    .wrap{display:grid;grid-template-columns:minmax(280px,1fr) 360px;gap:16px;align-items:stretch;height:100%;padding:16px;}
    #map{background:radial-gradient(1200px 800px at 30% 40%, #ffffff1a, transparent 60%);border-radius:18px;box-shadow:0 18px 45px #00000033;}
    .side{background:var(--panel);border-radius:18px;padding:18px 18px 12px;display:flex;flex-direction:column;gap:12px}
    .title{font-size:20px;font-weight:800;color:var(--ink);letter-spacing:.02em}
    .meta{font-size:13px;color:#374151;line-height:1.4}
    .pill{display:inline-block;font-size:12px;background:#1118270f;color:#111827;padding:4px 8px;border-radius:999px;margin-right:6px}
    .btn{appearance:none;border:0;background:var(--ink);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .muted{font-size:12px;color:#6b7280}
    @media (max-width: 1000px){ .wrap{grid-template-columns:1fr;grid-auto-rows:minmax(240px,auto)} }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map" aria-label="中国地図"></div>

  <aside class="side" id="panel">
    <div class="title">中国地図（省級）</div>
    <div class="meta">
      右のファイルを読み込み、各省・自治区・直轄市を正しい地形で表示します。<br/>
      <span class="pill">操作</span>ドラッグで移動 / ホイールで拡大縮小 / クリックで詳細
    </div>
    <hr style="border:none;height:1px;background:#e5e7eb;margin:6px 0 8px" />
    <div id="info" class="meta">地域をクリックするとここに情報を表示します。</div>
    <div class="muted">データ：Natural Earth / OSM など由来の GeoJSON</div>
    <button class="btn" id="btnReset">リセット</button>
  </aside>
</div>

<!-- ▼あなたの SVG と各 <path class="province" data-name="…"> はそのまま残す -->

<!-- D3 読み込み -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async () => {
  // 1) GeoJSON を読み込み（Natural Earth/OSM 由来の省級）
  const geo = await fetch('china-provinces.geojson.json').then(r => r.json());

  // 2) “新疆→黒龍江（台湾除外）” の対応表（data-name → ISOコード）
  const name2iso = {
    '新疆':'CN-XJ','西藏':'CN-XZ','青海':'CN-QH','内蒙古':'CN-NM','甘粛':'CN-GS','寧夏':'CN-NX',
    '陝西':'CN-SN','四川':'CN-SC','重慶':'CN-CQ','雲南':'CN-YN','貴州':'CN-GZ','広西':'CN-GX',
    '広東':'CN-GD','海南':'CN-HI','湖南':'CN-HN','湖北':'CN-HB','江西':'CN-JX','河南':'CN-HA',
    '山西':'CN-SX','河北':'CN-HE','北京':'CN-BJ','天津':'CN-TJ','山東':'CN-SD','江蘇':'CN-JS',
    '上海':'CN-SH','浙江':'CN-ZJ','安徽':'CN-AH','福建':'CN-FJ','遼寧':'CN-LN','吉林':'CN-JL',
    '黒龍江':'CN-HL'
  };

  // 3) 省フィーチャの取り出し（iso_3166_2 / code_hasc / name に広く対応）
  const feats = geo.features.filter(f => {
    const p = f.properties || {};
    const isChina = (p.adm0_a3 === 'CHN') || (p.iso_a2 === 'CN') || /China/i.test(p.admin || '');
    const notTaiwan = !/Taiwan|CN-71|TW/.test(String(p.name || p.name_en || p.iso_3166_2 || ''));
    return isChina && notTaiwan;
  });

  const byISO = new Map();
  for (const f of feats) {
    const p = f.properties || {};
    const iso = p.iso_3166_2 || (p.code_hasc ? p.code_hasc.replace('CN.', 'CN-') : '');
    if (iso) byISO.set(iso, f);
  }

  // 名前一致のフォールバック（NEの英語名に対応）
  const byName = new Map();
  for (const f of feats) {
    const p = f.properties || {};
    const nm = (p.name_zh || p.name || p.name_en || '').toLowerCase();
    if (nm) byName.set(nm, f);
  }
  const isoFallback = {
    'CN-XJ': /xinjiang/i,
    'CN-XZ': /(xizang|tibet)/i,
    'CN-NM': /(nei mongol|inner mongolia)/i,
    'CN-GS': /gansu/i, 'CN-NX': /ningxia/i, 'CN-QH': /qinghai/i, 'CN-SN': /shaanxi/i,
    'CN-SC': /sichuan/i, 'CN-CQ': /chongqing/i, 'CN-YN': /yunnan/i, 'CN-GZ': /guizhou/i,
    'CN-GX': /guangxi/i, 'CN-GD': /guangdong/i, 'CN-HI': /hainan/i, 'CN-HN': /hunan/i,
    'CN-HB': /hubei/i, 'CN-JX': /jiangxi/i, 'CN-HA': /henan/i, 'CN-SX': /shanxi(?!a)/i,
    'CN-HE': /hebei/i, 'CN-BJ': /beijing/i, 'CN-TJ': /tianjin/i, 'CN-SD': /shandong/i,
    'CN-JS': /jiangsu/i, 'CN-SH': /shanghai/i, 'CN-ZJ': /zhejiang/i, 'CN-AH': /anhui/i,
    'CN-FJ': /fujian/i, 'CN-LN': /liaoning/i, 'CN-JL': /jilin/i, 'CN-HL': /heilongjiang/i
  };

  function getFeatureForDataName(cnName) {
    const iso = name2iso[cnName];
    if (!iso) return null;
    if (byISO.has(iso)) return byISO.get(iso);
    // code_hasc などに無い場合は名称で検索
    const re = isoFallback[iso];
    if (re) return feats.find(f => re.test(String(f.properties?.name || f.properties?.name_en || '')));
    return null;
  }

  // 4) プロジェクション設定（あなたの viewBox にフィット）
  const svg = document.querySelector('svg.china-map');
  const vb = (svg.getAttribute('viewBox') || '0 0 800 600').split(/\s+/).map(Number);
  const size = [vb[2], vb[3]];

  // 使用する省だけをまとめて全国フィット
  const selected = {
    type: 'FeatureCollection',
    features: Array.from(document.querySelectorAll('.province'))
      .map(el => getFeatureForDataName(el.dataset.name))
      .filter(Boolean)
  };

  const projection = d3.geoMercator();
  const path = d3.geoPath(projection);
  projection.fitSize(size, selected);

  // 5) 各 <path> の d を “正しい地形” に置き換え（台湾はそもそも対象外）
  document.querySelectorAll('.province').forEach(el => {
    const f = getFeatureForDataName(el.dataset.name);
    if (!f) { console.warn('見つからない:', el.dataset.name); return; }
    el.setAttribute('d', path(f));
    // 推奨の見た目（任意）：線は縮尺非依存
    el.setAttribute('vector-effect','non-scaling-stroke');
    if (!el.getAttribute('stroke')) el.setAttribute('stroke','#fff');
    if (!el.getAttribute('stroke-width')) el.setAttribute('stroke-width','1.2');
    if (!el.getAttribute('fill')) el.setAttribute('fill','#ff6b9a');
  });
})();
</script>
</body>
</html>
