<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>中国地図（実形・省級行政区）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root{
      --bg1:#4f46e5; --bg2:#8b5cf6;
      --panel:#ffffffd9; --ink:#111827;
      --accent:#f59e0b; --stroke:#ffffff;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:linear-gradient(145deg,var(--bg1),var(--bg2));}
    .wrap{display:grid;grid-template-columns:minmax(280px,1fr) 360px;gap:16px;align-items:stretch;height:100%;padding:16px;}
    #map{background:radial-gradient(1200px 800px at 30% 40%, #ffffff1a, transparent 60%);border-radius:18px;box-shadow:0 18px 45px #00000033;}
    .side{background:var(--panel);border-radius:18px;padding:18px 18px 12px;display:flex;flex-direction:column;gap:12px}
    .title{font-size:20px;font-weight:800;color:var(--ink);letter-spacing:.02em}
    .meta{font-size:13px;color:#374151;line-height:1.4}
    .pill{display:inline-block;font-size:12px;background:#1118270f;color:#111827;padding:4px 8px;border-radius:999px;margin-right:6px}
    .btn{appearance:none;border:0;background:var(--ink);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .muted{font-size:12px;color:#6b7280}
    @media (max-width: 1000px){ .wrap{grid-template-columns:1fr;grid-auto-rows:minmax(240px,auto)} }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map" aria-label="中国地図"></div>

  <aside class="side" id="panel">
    <div class="title">中国地図（省級）</div>
    <div class="meta">
      右のファイルを読み込み、各省・自治区・直轄市を正しい地形で表示します。<br/>
      <span class="pill">操作</span>ドラッグで移動 / ホイールで拡大縮小 / クリックで詳細
    </div>
    <hr style="border:none;height:1px;background:#e5e7eb;margin:6px 0 8px" />
    <div id="info" class="meta">地域をクリックするとここに情報を表示します。</div>
    <div class="muted">データ：Natural Earth / OSM など由来の GeoJSON</div>
    <button class="btn" id="btnReset">リセット</button>
  </aside>
</div>

<script>
(async function () {
  // 1) GeoJSON を読み込み（同フォルダに置いたファイル名）
  const urls = ['china-provinces.geojson.json', 'Taiwan.geojson.json'];

  // ファイル読み込み（CORSで落ちる時はローカルサーバーで開いてください）
  const [china, taiwan] = await Promise.all(
    urls.map(u => fetch(u).then(r => {
      if(!r.ok) throw new Error('GeoJSONを読み込めません: ' + u);
      return r.json();
    }))
  );

  // 2) 特徴量をマージして 1 つの地図に
  const combined = {
    type: 'FeatureCollection',
    features: [...(china.features || []), ...(taiwan.features || [])]
  };

  // 3) ラベルに使う名称を整備（日本語→繁体→簡体→英語の順で優先）
  const pickName = (p) =>
    p.name_ja || p.name_zht || p.name_zh || p.name || p.NAME || p.name_en || '名称不明';

  for (const f of combined.features) {
    const p = f.properties || (f.properties = {});
    p.display_name = pickName(p);
    // EChartsのラベルは feature.properties.name を見るので上書き
    p.name = p.display_name;
  }

  // 4) 地図を登録
  echarts.registerMap('china-full', combined, {});

  // 5) 描画
  const chart = echarts.init(document.getElementById('map'), null, {renderer:'canvas'});
  const option = {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      formatter: (p) => {
        const pr = p?.data?.properties || p?.data || {};
        const t = pr.type_en || pr.type || '';
        const iso = pr['iso_3166_2'] || pr.adm1_code || pr.code_hasc || '';
        return `<div style="font-weight:700">${pr.display_name || p.name}</div>
                <div style="font-size:12px;color:#6b7280">${t} ${iso ? '・ '+iso : ''}</div>`;
      }
    },
    geo: {
      map: 'china-full',
      roam: true,
      zoom: 1.05,
      nameProperty: 'name', // 上で整備した名前を使う
      // 見やすい配色
      itemStyle: {
        areaColor: '#f472b6',
        borderColor: '#ffffff',
        borderWidth: 1.1
      },
      emphasis: {
        itemStyle: { areaColor: '#f59e0b' },
        label: { show: true, fontWeight: 'bold', color: '#111' }
      },
      select: {
        itemStyle: { areaColor: '#fcd34d' },
        label: { show: true, color: '#111', fontWeight: 'bold' }
      },
      label: {
        show: true,
        fontSize: 11,
        color: '#111',
        formatter: (p) => (p?.data?.properties?.display_name || p.name)
      }
    },
    series: [{
      type: 'map',
      map: 'china-full',
      nameProperty: 'name',
      selectedMode: 'single',
      // 値は不要だが、クリックでプロパティにアクセスできるよう渡す
      data: combined.features.map(f => ({ name: f.properties.name, value: 0, properties: f.properties }))
    }]
  };
  chart.setOption(option);

  // 6) クリックで右側パネル更新
  chart.on('click', function (p) {
    const pr = p?.data?.properties || {};
    const el = document.getElementById('info');
    el.innerHTML = `
      <div style="font-size:18px;font-weight:800">${pr.display_name || p.name}</div>
      <div class="meta" style="margin-top:6px">
        種別：${pr.type_ja || pr.type_en || pr.type || '不明'}　
        コード：${pr['iso_3166_2'] || pr.adm1_code || pr.code_hasc || '—'}
      </div>
      <div class="muted" style="margin-top:8px">
        中心座標（概算）：${(pr.longitude ?? '').toString().slice(0,8)}, ${(pr.latitude ?? '').toString().slice(0,8)}
      </div>
    `;
  });

  // リセットボタン
  document.getElementById('btnReset').addEventListener('click', () => {
    chart.dispatchAction({type:'restore'});
  });

  // リサイズ
  window.addEventListener('resize', () => chart.resize());
})();
</script>
</body>
</html>
