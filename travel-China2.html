<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¸­å›½æ—…è¡Œãƒãƒƒãƒ—ï¼ˆçœå¢ƒç•Œã¤ãï¼‰</title>
<style>
  :root {
    --bg1:#5c5ad7; --bg2:#a58be0;
    --card:#f5e9cf; --ink:#222;
    --stroke:#ffffffa8; --hover:#ffd54f; --fill:#b9d08a;
  }
  body{margin:0;font-family:system-ui,Segoe UI,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:radial-gradient(1200px 600px at 50% -10%,var(--bg2),var(--bg1));color:var(--ink)}
  header{position:sticky;top:0;background:color-mix(in oklab,var(--card) 86%,white 14%);padding:14px 22px;box-shadow:0 6px 22px #0002}
  main{max-width:1150px;margin:28px auto;padding:12px}
  .stage{display:grid;grid-template-columns: 1.2fr .9fr; gap:24px}
  .panel{background:#ffffff22;border-radius:18px;padding:18px 18px 22px;backdrop-filter: blur(10px);box-shadow:0 20px 40px #0003}
  h1{margin:6px 0 12px;font-size:28px;letter-spacing:.06em;color:#fff;text-shadow:0 3px 10px #0006}
  #mapWrap{position:relative;min-height:560px}
  svg{width:100%;height:560px;display:block;border-radius:14px}
  .province{fill:var(--fill);stroke:var(--stroke);stroke-width:.8px;cursor:pointer;transition:filter .2s, transform .05s}
  .province:hover{filter:brightness(1.05)}
  .province.focus{filter: drop-shadow(0 0 10px #0006);stroke-width:1.8px;stroke:var(--hover)}
  .tooltip{position:absolute;pointer-events:none;background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;
           box-shadow:0 8px 22px #0003;transform:translate(-50%,-120%);white-space:nowrap}
  .detail h2{margin:.2rem 0 .6rem;font-size:26px;text-align:center;color:#d58a00;text-shadow:0 2px 8px #0002}
  .card{background:#ffffffb8;border-radius:16px;padding:12px;box-shadow:inset 0 1px 0 #fff8, 0 10px 24px #0002}
  .hero{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:12px;border:4px solid #e8d2a7;box-shadow:0 8px 16px #0002}
  .mute{opacity:.7}
  @media (max-width:980px){.stage{grid-template-columns:1fr}.panel{padding:14px}svg{height:520px}}
</style>
</head>
<body>
<header><strong>ğŸ ä¸­å›½æ—…è¡Œãƒãƒƒãƒ—</strong></header>

<main class="stage">
  <section class="panel" id="mapWrap">
    <h1>ä¸­å›½åœ°å›³ï¼ˆçœãƒ»è‡ªæ²»åŒºãƒ»ç›´è½„å¸‚ï¼‰</h1>
    <svg id="chinaMap" role="img" aria-label="China provinces map"></svg>
    <div id="tip" class="tooltip" style="display:none"></div>
  </section>

  <aside class="panel detail">
    <h2 id="title" class="mute">åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <div class="card">
      <img id="photo" class="hero" src="" alt="" />
      <p id="desc" style="margin:.8rem 0 0;line-height:1.7" class="mute">
        å·¦ã®åœ°å›³ã§åœ°åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã“ã«å†™çœŸã¨èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </p>
    </div>
  </aside>
</main>

<!-- D3.js -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async function(){
  // 1) çœã”ã¨ã®ç”»åƒã¨èª¬æ˜ï¼ˆå¿…è¦ã«å¿œã˜ã¦å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰
  const info = {
    "è¥¿è—|ãƒãƒ™ãƒƒãƒˆ|Tibet": {
      img: "https://images.unsplash.com/photo-1544735716-392fe2489ffa?q=80&w=1280&auto=format&fit=crop",
      desc: "ä¸–ç•Œã®å±‹æ ¹ãƒ»é›ªåŸŸé«˜åŸã®ç¥ç§˜çš„ãªåœŸåœ°ã€‚ãƒ©ã‚µã®ãƒã‚¿ãƒ©å®®ã€ãƒŠãƒ ãƒ„ã‚©æ¹–ã€ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆåŒ—å´BCãªã©ãŒäººæ°—ã€‚"
    },
    "æ–°ç–†|Xinjiang": {
      img: "https://images.unsplash.com/photo-1535747790212-30c585ab4862?q=80&w=1280&auto=format&fit=crop",
      desc: "ã‚·ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ‰ã®äº¤å·®ç‚¹ã€‚ãƒˆãƒ«ãƒ•ã‚¡ãƒ³ã€å–€ä»€ã€å¤©å±±ã®é›„å¤§ãªè‡ªç„¶ã¨å¤šå½©ãªé£Ÿæ–‡åŒ–ã€‚"
    },
    "åŒ—äº¬|Beijing": {
      img: "https://images.unsplash.com/photo-1557579112-2d0f6d5f5d02?q=80&w=1280&auto=format&fit=crop",
      desc: "é¦–éƒ½ãƒ»ç´«ç¦åŸã€å¤©å£‡ã€ä¸‡é‡Œã®é•·åŸã€‚æ­´å²ã¨ãƒ¢ãƒ€ãƒ³ãŒèåˆã€‚"
    },
    "ä¸Šæµ·|Shanghai": {
      img: "https://images.unsplash.com/photo-1505764706515-aa95265c5abc?q=80&w=1280&auto=format&fit=crop",
      desc: "å¤–ç˜ã¨æµ¦æ±ã®å¤œæ™¯ã€æ­´å²å»ºç¯‰ã¨å…ˆç«¯éƒ½å¸‚ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€‚"
    }
    // â€¦å¿…è¦ã«å¿œã˜ã¦ä»–åœ°åŸŸã‚‚è¿½åŠ 
  };

  // 2) åœ°å›³ã®ãƒ™ãƒ¼ã‚¹è¨­å®š
  const svg = d3.select("#chinaMap");
  const width = svg.node().clientWidth;
  const height = svg.node().clientHeight;

  // ãƒ¡ãƒ«ã‚«ãƒˆãƒ«ã‚ˆã‚Šä¸­å›½ã¯ Albers ç³»ãŒæ­ªã¿ãŒå°‘ãªã„
  const projection = d3.geoMercator() // æ‰‹è»½ã•å„ªå…ˆã€‚å¿…è¦ãªã‚‰ d3.geoConicEqualArea() ã«å¤‰æ›´å¯
      .center([104, 35.5]) // ä¸­å›½ã®é‡å¿ƒä»˜è¿‘
      .scale(700)          // è¦‹ãŸç›®ã«åˆã‚ã›ã¦å¾®èª¿æ•´
      .translate([width/2, height/2+10]);

  const path = d3.geoPath().projection(projection);

  // 3) GeoJSON èª­ã¿è¾¼ã¿ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« china-provinces.geojson ã‚’ç½®ãï¼‰
  const geo = await fetch("./china-provinces.geojson").then(r => r.json());

  // 4) æç”»
  const g = svg.append("g");

  // æµ·å¤–é›¢å³¶ãªã©å°ã•ãªç©´ã®è¦‹æ „ãˆã‚’è‰¯ãã™ã‚‹ãŸã‚ã«ã‚½ãƒ¼ãƒˆ
  const features = geo.features.slice().sort((a,b)=> d3.geoArea(b)-d3.geoArea(a));

  g.selectAll("path.province")
    .data(features)
    .join("path")
      .attr("class","province")
      .attr("d", path)
      .on("pointerenter", function (event, d) {
        const name = getName(d);
        d3.select(this).classed("focus", true);
        showTip(event, name);
      })
      .on("pointermove", function (event, d) {
        showTip(event, getName(d));
      })
      .on("pointerleave", function () {
        d3.select(this).classed("focus", false);
        hideTip();
      })
      .on("click", (event, d) => {
        const name = getName(d);
        focusProvince(name, event.currentTarget);
      });

  // 5) æç”»å¾Œã«å°æ¹¾ã®è‰²ã‚’å°‘ã—ã ã‘å¤‰ãˆã‚‹ï¼ˆã”å¸Œæœ›ãŒã‚ã£ãŸãŸã‚ï¼‰
  g.selectAll("path.province").each(function(d){
    const n = getName(d);
    if (/å°æ¹¾|Taiwan/i.test(n)) d3.select(this).attr("fill", "#b7cf96");
  });

  // 6) å³ãƒ‘ãƒãƒ«æ›´æ–°
  function focusProvince(name, node){
    g.selectAll(".province").classed("focus", false);
    d3.select(node).classed("focus", true);

    const key = findInfoKey(name);
    const data = key ? info[key] : null;

    document.getElementById("title").textContent = name;
    const photo = document.getElementById("photo");
    const desc  = document.getElementById("desc");
    if (data){
      photo.src = data.img;
      photo.alt = name;
      desc.textContent = data.desc;
      document.getElementById("title").classList.remove("mute");
      desc.classList.remove("mute");
    } else {
      photo.src = "";
      photo.alt = "";
      desc.textContent = "ã“ã®åœ°åŸŸã®èª¬æ˜ã¯æœªè¨­å®šã§ã™ã€‚info ãƒãƒƒãƒ—ã«ç”»åƒURLã¨èª¬æ˜æ–‡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
      document.getElementById("title").classList.remove("mute");
      desc.classList.add("mute");
    }
  }

  // 7) çœåã®å–ã‚Šå‡ºã—ï¼ˆGeoJSON ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å·®ç•°ã‚’å¸åï¼‰
  function getName(f){
    const p = f.properties || {};
    return p.name || p.NAME || p.NAME_1 || p.Name || p.fullname || p.admin || "ä¸æ˜";
  }

  // 8) ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
  const tip = document.getElementById("tip");
  function showTip(ev, text){
    tip.style.display="block";
    tip.textContent = text;
    const r = svg.node().getBoundingClientRect();
    tip.style.left = (ev.clientX - r.left) + "px";
    tip.style.top  = (ev.clientY - r.top) + "px";
  }
  function hideTip(){ tip.style.display="none"; }

  // 9) info æ¤œç´¢ï¼ˆæ—¥æœ¬èªãƒ»ä¸­å›½èªãƒ»è‹±èªã®è¡¨è¨˜ã‚†ã‚Œå¯¾å¿œï¼‰
  function findInfoKey(name){
    name = String(name);
    return Object.keys(info).find(k => k.split("|").some(x => name.includes(x)));
  }

  // 10) ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆç°¡æ˜“ï¼‰
  addEventListener("resize", () => {
    const w = svg.node().clientWidth, h = svg.node().clientHeight;
    projection.translate([w/2, h/2+10]).scale(700 * (w/1000));
    g.selectAll("path").attr("d", path);
  });
})();
</script>

</body>
</html>
